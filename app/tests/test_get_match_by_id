from fastapi.testclient import TestClient
from fastapi import status
from models.room import *
from main import app


client = TestClient(app)
repo = RoomRepository()

from models.match import *
from models.room import * 

repo_room = RoomRepository()
repo_match = MatchRepository()

def reset():
    for i in range(1,7):
        if repo_room.get_room_by_id(i):
            repo_room.delete(i)
        if repo_match.get_match_by_id(i):
            repo_match.delete(i)

def generate_test_room():
    db = Session()
    try:
        roombd1 = Room(
                room_name="Room 1",
                room_id=1,
                players_expected=2,
                owner_name="Braian",
                players_names=json.dumps(["Braian","Tadeo"]),
                is_active=True
            )
        roombd2 = Room(
                room_name="Room 2",
                room_id=2,
                players_expected=3,
                owner_name="Braian",
                players_names=json.dumps(["Braian","Tadeo","Yamil"]),
                is_active=True
            )
        roombd3 = Room(
                room_name="Room 3",
                room_id=3,
                players_expected=4,
                owner_name="Braian",
                players_names=json.dumps(["Braian","Tadeo","Yamil","Mao"]),
                is_active=True
            )
        db.add(roombd1)
        db.add(roombd2)
        db.add(roombd3)
        db.commit()
    finally:
        db.close()    

def generate_test_match():
    try:
        match_1 = MatchOut(
                match_id=1
            )
        match_2 = MatchOut(
                match_id=2
            )
        match_3 = MatchOut(
                match_id=3
            )
        match_1_db = repo_match.create_match(match_1)
        match_2_db = repo_match.create_match(match_2)
        match_3_db = repo_match.create_match(match_3)
    except:
        assert False, f"Creando mal matchs en db"

def test_get_match_1():
    expected_match = repo_match.get_match_by_id(1)
    response = client.get("/matchs/1")    
    assert response.status_code == status.HTTP_200_OK
    assert response.json() == expected_match 